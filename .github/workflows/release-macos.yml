name: macOS Build, Sign & Notarize

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      skip_notarize:
        description: "Skip notarization (faster for testing)"
        type: boolean
        default: false

jobs:
  build-sign-notarize:
    runs-on: macos-14
    timeout-minutes: 60

    strategy:
      matrix:
        arch: [arm64, x64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # -- Import signing certificate into a temporary keychain --
      - name: Import code signing certificate
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Decode certificate
          CERT_PATH="$RUNNER_TEMP/certificate.p12"
          echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > "$CERT_PATH"

          # Create temporary keychain
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -hex 20)"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          security import "$CERT_PATH" \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          # Allow codesign to access the keychain without prompting
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Add temporary keychain to search list
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')

          # Verify
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

          # Clean up cert file
          rm -f "$CERT_PATH"

      # -- Store notarization credentials --
      - name: Store notarization credentials
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        run: |
          xcrun notarytool store-credentials "DuckGameRebuilt-macos" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD"

      # -- Build, sign, notarize --
      - name: Build, sign, and notarize (${{ matrix.arch }})
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        run: |
          ARGS=(--arch "${{ matrix.arch }}" --identity "$APPLE_SIGNING_IDENTITY")

          # Use tag name as version, or 'dev' for dispatch runs
          if [[ "$GITHUB_REF_TYPE" == "tag" ]]; then
            ARGS+=(--version "${GITHUB_REF_NAME#v}")
          else
            ARGS+=(--version "dev-$(git rev-parse --short HEAD)")
          fi

          # Skip notarization if requested via dispatch input
          if [[ "${{ inputs.skip_notarize }}" == "true" ]]; then
            ARGS+=(--skip-notarize)
          fi

          bun scripts/release-macos.ts "${ARGS[@]}"

      # -- Upload DMG as artifact (always) --
      - name: Upload DMG as artifact
        uses: actions/upload-artifact@v4
        with:
          name: DuckGameRebuilt-macos-${{ matrix.arch }}
          path: dist/macos/DuckGameRebuilt-macos-${{ matrix.arch }}.dmg

      # -- Upload DMG to GitHub Release (only on tag push) --
      - name: Upload DMG to release
        if: github.ref_type == 'tag'
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: dist/macos/DuckGameRebuilt-macos-${{ matrix.arch }}.dmg
          asset_name: DuckGameRebuilt-macos-${{ matrix.arch }}.dmg
          tag: ${{ github.ref }}
          overwrite: true

      # -- Cleanup keychain --
      - name: Cleanup keychain
        if: always()
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          if [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH"
          fi
