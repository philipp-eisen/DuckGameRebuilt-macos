# net8 osx-arm64 migration learnings

## 2026-02-15

- The main game project is legacy .NET Framework 4.8 and non-SDK style (`DuckGame/DuckGame.csproj`), so `dotnet publish -r osx-arm64` cannot be done directly without a parallel SDK-style project or full in-place migration.
- Startup currently routes through `DGWindows.WindowsPlatformStartup`, which is Windows-specific and uses Win32 APIs.
- Boot-critical runtime paths use `System.Drawing`:
  - `DuckGame/src/MonoTime/Content/TextureConverter.cs`
  - `DuckGame/src/MonoTime/Render/1Windows_Font.cs`
- There are broad Windows-only imports in the game code (`System.Windows.Forms`, `System.Windows.*`, `System.Web`) that need a compatibility pass for net8.
- Existing non-Windows flow in repo is Mono/msbuild-based and copies `deps/*` ad hoc after build; this is not a RID-aware publish flow.
- Steam is intentionally excluded in phase 1 per requirement.
- Environment tooling constraint discovered during execution:
  - previously `dotnet`/`msbuild` were unavailable; this is now resolved for `dotnet` via Homebrew SDK 8.x
- A parallel net8 project lane is now in-repo:
  - `DuckGame/DuckGame.Net8.csproj`
  - `Steam/Steam.Net8.csproj`
- Compile-compatibility scaffolding added for net8:
  - `DuckGame/src/Compat/Net8/SystemWindowsFormsCompat.cs`
  - `DuckGame/src/Compat/Net8/SystemNamespaceCompat.cs`
  - `DuckGame/src/Platform/WindowsPlatformStartup.Net8.cs`
- Runtime compatibility changes implemented:
  - `Program.cs` now has `NO_STEAM` guarded startup and crash-loop steam calls
  - CrashWindow launch now routes through a Windows-guarded helper
  - net8 fallback font context added (`FontGDIContext.Net8.cs`)
  - net8 texture conversion implemented via ImageSharp (`TextureConverter.Net8.cs`)
- Publish scaffolding implemented:
  - `scripts/publish-macos-arm64.sh`
  - `DuckGame/build/native/osx-arm64/README.md`
  - `docs/migration/net8-macos-phase1.md`
- SDK bootstrap gate is now green:
  - `which dotnet` -> `/opt/homebrew/opt/dotnet@8/bin/dotnet`
  - `dotnet --version` -> `8.0.124`
  - `dotnet --info` reports `RID: osx-arm64`, host architecture `arm64`
- Net8 lane compile verification now passes in both Debug and Release (`dotnet build ... -clp:ErrorsOnly`), with warnings but no errors.
- Publish verification now passes via `scripts/publish-macos-arm64.sh`; required native dylibs are in publish output.
- Native linkage fix is effective: `otool -L` for `libFNA3D.0.dylib` now references SDL as `@rpath/libSDL2-2.0.0.dylib` rather than Homebrew absolute path.
- Runtime smoke check result is stable for short launch: published binary remains alive for 8 seconds and emits no stderr/stdout to `run.log`.
- Steam-off packaging adjustment: publish script no longer force-copies `Steamworks.NET.dll`/config from `deps`.
- Attempting to fully remove Steam managed assemblies from publish output caused a startup stack overflow in `Program.Resolve` -> `AssemblyLoadContext.InvokeResolveEvent` recursion during marker/type scanning. Restoring Steam managed assemblies in output returns to stable startup (`ALIVE_AFTER_8S`).
- Current phase-1 posture is therefore: Steam runtime paths are disabled by `NO_STEAM`, but Steam managed assemblies remain present to satisfy reflection-time assembly resolution.
- Dependency hygiene note: restore reports a moderate advisory on `SixLabors.ImageSharp` 3.1.9 (`GHSA-rxmq-m78w-7wmc`), which should be reviewed before final handoff.
- Additional no-Steam runtime guards were required in live title-screen flow (`MonoMain`, `Level`, `Unlockables`, `TeamSelect2`, `TitleScreen`, `Main`) to avoid Steam type loads during startup/update.
- With those guards, current publish smoke result is stable for 60 seconds at title-screen runtime without a fatal Steamworks assembly exception.
- `ducklog.txt` still logs repeated `GlobalData` parse warnings; these are non-fatal but should be triaged for save-data compatibility.
- Music load can still report missing `NVorbis` in logs during startup, indicating a likely packaging/reference gap that may impact audio even when runtime no longer crashes.
- `TeamSelect2` remained a recurring no-Steam crash source (type-load paths via title/duck update). Current no-Steam stabilization prevents title-screen transitions into `TeamSelect2` to keep runtime alive; multiplayer/team-select functionality is therefore intentionally limited in this lane for now.
- User requirement changed: keep TeamSelect2 playable; migration pivoted back to Steam-enabled net8 lane instead of deeper no-Steam decoupling.
- `Steamworks.NET` managed assembly from package/reference is PE32+ x64 and throws `FileLoadException` on `osx-arm64` net8 unless module metadata is patched to AnyCPU. A publish-time Mono.Cecil patch (I386 + clear 32-bit flags) resolves this load blocker.
- Steam native bootstrap on macOS required `steam_api64` library names; copying bundle binary aliases (`steam_api64.dylib` and `libsteam_api64.dylib`) from `steam_api.bundle/Contents/MacOS/libsteam_api.dylib` resolved `DllNotFoundException`.
- After managed+native Steam fixes, runtime reaches normal startup loop on arm64 and survives 60-second smoke runs; when not launched from a live Steam session, `SteamAPI_Init` fails gracefully and logs `Steam INIT Failed!`.
