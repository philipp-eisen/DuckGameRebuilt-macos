# net8 + osx-arm64 Publish Path Plan (Phase 1)

## Objective
- Deliver a **real `dotnet publish -r osx-arm64` path** for this repo that produces a **bootable game build** on Apple Silicon.
- Phase 1 explicitly **excludes Steam runtime integration** (user-selected).
- Keep existing Windows/net48 build path working during migration.
- During implementation, keep live execution-tracking docs updated (`progress.md`, `learnings.md`, `next-steps.md`).

## Scope and Non-Goals
- In scope (phase 1): build/publish on `net8`, boot to menu/gameplay, package required native mac libs, disable Steam cleanly, avoid Windows-only runtime crashes.
- Out of scope (phase 1): full feature parity with Windows-only features (CrashWindow, dynamic GDI raster fonts, Windows TTS, Steam features).
- Out of scope (phase 1): NativeAOT. This plan is for normal .NET 8 publish, not AOT.

## Execution Policy
- Execute continuously until the full plan is implemented.
- Do not pause between phases unless blocked by a hard external dependency (missing credentials, unavailable artifact, ambiguous product decision).
- Toolchain blockers are **self-unblock tasks**, not stop conditions. If `dotnet`/SDK is missing, install and verify SDK 8.x in-repo before continuing.
- We are explicitly authorized to install .NET SDK 8.x on this machine as part of execution.
- If a true external blocker remains, document blocker + fallback in `next-steps.md` and continue all non-blocked work.
- Verify each sub-step to the best possible extent before moving forward.
- Commit incrementally after each verified sub-step (small, focused commits only).

## Progress Tracking Artifacts
- `progress.md` (repo root):
  - Tracks checklist status by phase/task (`pending`, `in_progress`, `done`, `blocked`).
  - Updated immediately after every meaningful implementation step.
- `learnings.md` (repo root):
  - Captures technical findings, gotchas, compatibility notes, and validated assumptions.
  - Updated whenever a new behavior/constraint is discovered.
- `next-steps.md` (repo root):
  - Ordered queue of remaining tasks, blockers, and recovery actions.
  - Updated at every handoff and whenever priorities shift.

Update cadence requirement:
- At phase start: sync all three files.
- After each commit-sized change: update `progress.md` + `learnings.md` if relevant.
- At phase completion: refresh `next-steps.md` before moving on.

## Commit and Verification Policy
- Commit model:
  - One commit per meaningful, verified sub-step.
  - Keep commits scoped (project setup, compile fix batch, runtime fix batch, publish packaging, docs/tracking updates).
  - Include tracking docs (`progress.md`, `learnings.md`, `next-steps.md`) in each commit when their content changed.
- Verification before commit:
  - Run the narrowest validation that proves the sub-step is correct (compile, targeted run, publish dry-run, smoke check).
  - If full verification is not possible in that sub-step, record exactly what was verified and what remains in `learnings.md` and `next-steps.md`.
- Commit acceptance gate:
  - Commit only when sub-step is stable and rollback-safe.
  - If verification fails, fix first or split work into a smaller sub-step and re-verify.

## Current Blockers (from codebase)
- Main app is legacy net48 non-SDK project: `DuckGame/DuckGame.csproj`.
- Startup is Windows-specific: `DuckGame/src/WindowsPlatformStartup.cs` and `StartupObject` points there.
- Boot-critical runtime uses Windows-only graphics APIs:
  - `DuckGame/src/MonoTime/Content/TextureConverter.cs` (`System.Drawing.Bitmap` path)
  - `DuckGame/src/MonoTime/Render/1Windows_Font.cs` + `DuckGame/src/MonoTime/Render/RasterFont.cs` (GDI/font rasterization)
- Multiple source files import Windows-only namespaces (`System.Windows.Forms`, `System.Web`, `System.Windows.*`).
- Publish layout is currently ad hoc (`deps/*` copied in `AfterBuild`), not RID-driven.
- macOS arm64 native stack is incomplete in publish layout (Steam dylib exists, core SDL2/FNA3D/FAudio/theorafile mac dylibs are not staged for publish).

---

## Recommended Implementation Strategy
Use a **parallel net8 project** for phase 1 instead of rewriting the existing net48 project in-place.

Why this is the minimum-risk path:
- Keeps current Windows/net48 build intact.
- Allows targeted mac fixes behind net8-only compile/publish config.
- Avoids destabilizing the large legacy `.csproj` immediately.

---

## Phase Plan (with exit criteria)

### Phase 0 - Baseline + branch safety
1. Create migration branch.
2. Record baseline commands/results for current net48 workflow.
3. Add migration note documenting phase-1 constraints.
4. Create `progress.md`, `learnings.md`, and `next-steps.md` with initial structure.
5. Verify docs/checklist structure is complete, then commit phase-0 baseline scaffold.

Exit criteria:
- Baseline net48 flow still reproducible.
- Scope/non-goals written down.

### Phase 0.5 - Mandatory SDK bootstrap (self-unblock gate)
1. Install .NET SDK 8.x locally if missing (`dotnet` command not found or no 8.x SDK listed).
2. Ensure shell PATH resolves the installed SDK first (`which dotnet` points to the expected install path).
3. Run the strict SDK verification checklist (see `SDK Bootstrap Verification Gate`) and record outputs in `learnings.md`.
4. If any checklist item fails, fix toolchain/path/arch issues before entering Phase 1.
5. Commit toolchain bootstrap notes + tracking updates after verification passes.

Status note:
- User has confirmed `dotnet` is now installed. Immediate next execution step is to run the full SDK Bootstrap Verification Gate and record results before any further implementation changes.

Exit criteria:
- `dotnet` is available in current shell and reports SDK 8.x.
- Host architecture and RID context are confirmed for Apple Silicon (`arm64`/`osx-arm64`).
- SDK verification gate is fully green and documented.

### Phase 1 - Create parallel SDK-style net8 build lane
1. Add new project `DuckGame/DuckGame.Net8.csproj` (SDK-style, `TargetFramework=net8.0`).
2. Reference modern/cross-platform dependencies and avoid legacy WindowsDesktop refs.
3. Add project constant(s): `DUCKGAME_NET8`, `NO_STEAM`.
4. Keep old `DuckGame/DuckGame.csproj` untouched.
5. Verify with `dotnet restore/build` for the new project, then commit phase-1 scaffolding.

Exit criteria:
- `dotnet build DuckGame/DuckGame.Net8.csproj -c Debug` starts compiling and reports actionable source issues (not project-format issues).

### Phase 2 - Make source compile on net8 (lowest-change compatibility pass)
1. Replace/remove Windows-only and legacy namespace imports that are unused (`System.Web`, `System.Windows.*`).
2. Route WinForms-like usages to existing proxy layer (`XnaToFna.ProxyForms`) where feasible.
3. Add tiny proxy shims only where missing (example: message box/thread-exception wrapper types if needed).
4. Net8-only stub for Windows startup class in namespace `DGWindows` to satisfy existing call sites without Win32 dependencies.
5. Verify net8 compile cleanly; commit compile-compat batch.

Exit criteria:
- `dotnet build DuckGame/DuckGame.Net8.csproj -c Debug` succeeds.

### Phase 3 - Boot-safe runtime path on mac (Steam excluded)
1. **Steam off path:** gate Steam init/update usage behind `NO_STEAM` in `Program` startup/crash paths.
2. **Crash UI path:** disable `CrashWindow.exe` launches on non-Windows; keep logging behavior.
3. **Font path:** avoid GDI raster font path on net8/mac by providing a net8 font fallback (`FontGDIContext` net8 stub + fallback to bitmap font behavior).
4. **Texture path:** replace `System.Drawing` PNG load/convert flow in net8 lane with cross-platform decode/transform (ImageSharp or equivalent), preserving:
   - magenta-to-transparent behavior
   - premultiplied alpha behavior
   - optional max-dimension resize behavior (exact quality can be approximate for phase 1)
5. Verify runtime smoke (menu + start match), then commit runtime-boot fixes.

Exit criteria:
- Local net8 run reaches menu and can start gameplay scene on macOS arm64 without immediate crash.

### Phase 4 - Real `dotnet publish -r osx-arm64` output layout
1. Add publish-time inclusion of runtime assets into output root (replacing ad hoc `AfterBuild` assumptions).
2. Stage mac arm64 native libs expected by FNA/interop in publish output.
3. Keep Steam native assets excluded/unused in phase 1.
4. Add one-command publish script for reproducibility.
5. Verify publish output + linkage checks, then commit packaging/publish lane.

Exit criteria:
- `dotnet publish DuckGame/DuckGame.Net8.csproj -c Release -r osx-arm64 --self-contained true` produces a runnable folder on a clean Apple Silicon machine.

### Phase 5 - Stabilization and handoff
1. Run full verification matrix (below).
2. Document known phase-1 limitations.
3. Preserve Windows/net48 lane unchanged.
4. Finalize tracking docs to reflect completion and commit final stabilization/docs pass.

Exit criteria:
- Verification matrix passes.
- Migration docs are sufficient for another dev to reproduce build+run.

---

## File-by-File Change Plan (minimum sequence)

### 1) New net8 build lane
- `DuckGame/DuckGame.Net8.csproj` (new)
  - SDK-style project, `net8.0`.
  - `AllowUnsafeBlocks=true`, language version aligned with repo.
  - Project refs:
    - `FNA/FNA.Core.csproj` (or net8-capable FNA variant)
    - net8-capable Steam project (below), even with `NO_STEAM` compile path.
  - Net8 compile includes/excludes for platform files.
  - Publish item groups for native files and `deps` assets.

- `Steam/Steam.Net8.csproj` (new)
  - SDK-style `net8.0` project from existing `Steam/src/*.cs`.
  - Minimal compile-compat project so DuckGame net8 can reference `Steam` types.
  - Runtime remains disabled in phase 1 via `NO_STEAM`.

### 2) Startup/platform glue
- `DuckGame/src/Program.cs`
  - Add `NO_STEAM` guards around Steam init/update-sensitive sections.
  - Guard/replace Windows-only crash window process launches on non-Windows.
  - Replace direct Windows-only executable path/message handling with cross-platform-safe wrappers where needed.

- `DuckGame/src/WindowsPlatformStartup.cs`
  - Keep for net48 builds.

- `DuckGame/src/Platform/WindowsPlatformStartup.Net8.cs` (new)
  - Net8 stub in namespace `DGWindows` that provides only required members used by `Program`.
  - No Win32/WinForms dependency.

### 3) WinForms/WPF/Web namespace cleanup (compile compatibility)
- Update imports and minimal call sites in files currently using `System.Windows.Forms`/`System.Windows.*`/`System.Web`.
- High-priority files to touch first:
  - `DuckGame/src/Program.cs`
  - `DuckGame/src/MonoTime/MonoMain.cs`
  - `DuckGame/src/MonoTime/Modding/ModLoader/ModLoader.cs`
  - `DuckGame/src/MonoTime/Console/Commands/Restart.cs`
  - `DuckGame/src/MonoTime/Console/Commands/DansTestArea.cs`
  - `DuckGame/src/MonoTime/Render/FancyBitmapFont.cs`
  - `DuckGame/src/MonoTime/Windows/DeviceChangeNotifier.cs`
  - `DuckGame/src/XnaToFna/XnaToFnaHelper.cs`
  - `DuckGame/src/MonoTime/Options.cs`
  - `DuckGame/src/MonoTime/Input/Input.cs`
  - `DuckGame/src/DuckGame/Profile/Profiles.cs`
  - `DuckGame/src/DuckGame/Levels/XMLLevel.cs`
  - `DuckGame/src/DuckGame/Levels/Deathmatch/GameLevel.cs`
  - `DuckGame/src/MonoTime/QuadTreeObjectList.cs`
  - `DuckGame/src/DuckGame/AutoPlatform.cs`
  - `DuckGame/src/DuckGame/AutoBlock.cs`

### 4) Font fallback for net8/mac
- `DuckGame/src/MonoTime/Render/1Windows_Font.cs` (exclude from net8 compile)
- `DuckGame/src/MonoTime/Render/Windows_Font.cs` (exclude from net8 compile)
- `DuckGame/src/MonoTime/Render/FontGDIContext.Net8.cs` (new)
  - Provide net8-safe `FontGDIContext` API surface used by `RasterFont`.
  - Return fallback behavior that does not invoke GDI.

### 5) Texture loading replacement for net8/mac
- `DuckGame/src/MonoTime/Content/TextureConverter.cs`
  - Option A (preferred for minimal churn): keep net48 file as-is, exclude from net8.
- `DuckGame/src/MonoTime/Content/TextureConverter.Net8.cs` (new)
  - Implement same public/internal methods with cross-platform image decode + pixel conversion.

- Call-site adjustments (to remove `Bitmap` construction in net8 path):
  - `DuckGame/src/MonoTime/Content/ContentPack.cs`
  - `DuckGame/src/DuckGame/Profile/Team.cs`
  - any additional call sites found in compile pass.

### 6) Speech/TTS compatibility
- `DuckGame/src/MonoTime/Sound/Speech.cs` (exclude from net8 compile)
- `DuckGame/src/MonoTime/Sound/Speech.Net8.cs` (new stub)
  - No-op implementation to keep API contract and avoid `System.Speech` dependency on mac.

### 7) Publish + native packaging
- `DuckGame/DuckGame.Net8.csproj`
  - Add publish item groups to copy runtime assets.

- `DuckGame/build/native/osx-arm64/*` (new folder)
  - Add required mac arm64 dylibs:
    - `libSDL2-2.0.0.dylib`
    - `libFNA3D.0.dylib`
    - `libFAudio.0.dylib`
    - `libtheorafile.dylib` (or exact expected name for bindings)

- `scripts/publish-macos-arm64.sh` (new)
  - Canonical publish command.

- `docs/migration/net8-macos-phase1.md` (new)
  - Build/publish/run and known limitations.

### 8) Execution-tracking files (required)
- `progress.md` (new)
  - Phase/task checklist with statuses, timestamps, and links to changed files.
- `learnings.md` (new)
  - Running log of migration findings, failures, and confirmed fixes.
- `next-steps.md` (new)
  - Prioritized remaining work + blockers + verification follow-ups.

### 9) Planned commit checkpoints
- Commit 1: planning/baseline tracking scaffolding (`progress.md`, `learnings.md`, `next-steps.md`, migration doc seed).
- Commit 2: SDK bootstrap/self-unblock proof (install notes, verification outputs in tracking docs, PATH/arch confirmation).
- Commit 3: add `DuckGame.Net8.csproj` + `Steam.Net8.csproj` + initial restore/buildable structure.
- Commit 4: compile-compatibility cleanup (namespace/import fixes, proxy shims, net8 startup stub).
- Commit 5: runtime boot fixes (Steam-off guards, crash path guards, font + texture net8-safe paths).
- Commit 6: publish/packaging implementation (`osx-arm64` native staging + publish script).
- Commit 7: stabilization/docs/final tracking sync after full verification.

---

## Temporary Shims vs Final Architecture

Temporary in phase 1:
- `NO_STEAM` compile/runtime gating.
- Net8 stub for `DGWindows.WindowsPlatformStartup`.
- Net8 stub for `Speech`.
- Font fallback that disables dynamic system raster font generation.
- Direct publish-copy of native libs from repo-managed folder.

Final (post phase 1):
- Proper platform abstraction for startup/crash handling.
- Steam as optional runtime feature toggle on mac once verified.
- Full cross-platform font and texture processing path with no legacy Windows code dependencies.
- Consolidate project structure (eventually replace legacy net48 `.csproj` rather than dual-lane long term).

---

## Verification Matrix

### SDK Bootstrap Verification Gate (must pass before Phase 1+ build/publish work)
1. `uname -m`
   - Pass: output is `arm64`.
   - Fail: output is not `arm64`; stop and correct environment/terminal architecture.
2. `which dotnet`
   - Pass: prints a real executable path and not an empty result.
   - Fail: no path; install SDK 8.x and fix PATH.
3. `dotnet --list-sdks`
   - Pass: includes at least one `8.0.xxx` SDK.
   - Fail: no 8.x SDK; install SDK 8.x.
4. `dotnet --info`
   - Pass: shows `RID: osx-arm64` (or host arch `arm64`) and no fatal startup errors.
   - Fail: x64-only/incorrect RID or startup errors; fix architecture/path before continuing.
5. `dotnet --version`
   - Pass: returns a single 8.x SDK version string.
   - Fail: non-8.x default SDK; pin via `global.json`/PATH as needed.
6. `dotnet restore DuckGame/DuckGame.Net8.csproj`
   - Pass: restore completes without SDK-not-found/toolchain errors.
   - Fail: any SDK/toolchain failure; resolve before build tasks.
7. `dotnet build DuckGame/DuckGame.Net8.csproj -c Debug`
   - Pass: command executes with normal compile diagnostics (source errors are allowed at this gate; toolchain errors are not).
   - Fail: SDK/host/runtime/toolchain failure; resolve before Phase 2+.

### Build checks
1. `dotnet restore DuckGame/DuckGame.Net8.csproj`
2. `dotnet build DuckGame/DuckGame.Net8.csproj -c Debug`
3. `dotnet build DuckGame/DuckGame.Net8.csproj -c Release`

### Publish checks
1. `dotnet publish DuckGame/DuckGame.Net8.csproj -c Release -r osx-arm64 --self-contained true`
2. Validate publish folder contains:
   - app host binary
   - managed game assemblies
   - required native dylibs
   - required content/deps assets

### Native linkage checks (mac)
1. `otool -L <published-app-binary>`
2. Verify expected dylib names are resolvable from publish folder.

### Runtime smoke checks (macOS arm64)
1. Launch published build from terminal.
2. Reach main menu.
3. Start local match and play briefly.
4. Confirm no immediate crashes from texture/font pipelines.
5. Confirm Steam is not initialized/required in phase 1.

### Regression check (existing lane)
1. Run existing net48 build command(s) on Windows lane.
2. Confirm no behavior change in default legacy workflow.

---

## Risks and Mitigation
- Risk: hidden Windows-only namespace/type usage still blocks compile.
  - Mitigation: iterative compile-fix pass, prioritize minimal import/type corrections.

- Risk: texture conversion output differences (premultiply/magenta handling) cause visual artifacts.
  - Mitigation: add visual regression smoke checks for UI + gameplay sprites; keep conversion logic parity tests on sample images.

- Risk: font fallback changes text layout.
  - Mitigation: accept as phase-1 limitation; default to bitmap fonts on mac.

- Risk: native dylib naming mismatch for FNA loaders.
  - Mitigation: enforce exact filename mapping expected by FNA and verify with runtime startup logs.

- Risk: `dotnet` installed but not selected due to PATH precedence.
  - Mitigation: verify `which dotnet`, restart shell/session as needed, and record the resolved path in `learnings.md`.

- Risk: x64 SDK/runtime used under Rosetta causing RID/loader mismatches.
  - Mitigation: enforce `uname -m=arm64`, confirm `dotnet --info` RID/arch, reinstall arm64 SDK if needed.

- Risk: publish output cannot locate native dylibs at runtime.
  - Mitigation: keep native dylibs in publish root, validate with `otool -L`, and avoid relying on ad hoc `DYLD_LIBRARY_PATH`.

- Risk: accidental breakage of net48 lane.
  - Mitigation: keep old project untouched; all net8-specific behavior behind new project and compile constants.

Rollback strategy:
- Keep migration in small phase commits.
- Any phase can be reverted independently while preserving prior working state.
- If runtime fixes stall, keep compile/publish lane and document blocked runtime items explicitly.

---

## Definition of Done (Phase 1)
- A reproducible `net8` `osx-arm64` publish command exists and is documented.
- Published output boots to menu and can enter gameplay on Apple Silicon.
- Steam is intentionally disabled and no Steam init is required.
- Boot-critical font/texture paths no longer depend on Windows-only runtime APIs.
- Existing Windows/net48 build path remains functional.
- `progress.md`, `learnings.md`, and `next-steps.md` are current and reflect the completed implementation state.
